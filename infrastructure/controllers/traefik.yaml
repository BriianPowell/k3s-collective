apiVersion: source.toolkit.fluxcd.io/v1beta2
kind: HelmRepository
metadata:
  name: traefik
  namespace: kube-system
spec:
  interval: 24h
  url: https://traefik.github.io/charts
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: traefik
  namespace: kube-system
spec:
  interval: 1h0m0s
  chart:
    spec:
      chart: traefik
      sourceRef:
        kind: HelmRepository
        name: traefik
        namespace: kube-system
      version: '>=26.0.0 <27.0.0'
  values:
    deployment:
      additionalVolumes:
        - name: plugins
    priorityClassName: system-cluster-critical
    tolerations:
      - key: CriticalAddonsOnly
        operator: Exists
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
    service:
      labels:
        monitor: traefik
      ipFamilyPolicy: PreferDualStack
    ports:
      web:
        redirectTo:
          port: websecure
      websecure:
        middlewares:
          - kube-system-bouncer@kubernetescrd
        tls:
          options: default
        forwardedHeaders:
          insecure: true
          trustedIPs:
            # - 0.0.0.0/0 # for testing, will allow all IPS
            - 127.0.0.1/32 # localhost
            - 10.0.0.0/16 # local subnet
            - 10.42.0.0/24 # Kubernetes Subnet
            - 10.43.0.0/24 # Kubernetes Subnet
        proxyProtocol:
          insecure: true
          trustedIPs:
            # - 0.0.0.0/0 # for testing, will allow all IPS
            - 127.0.0.1/32 # localhost
            - 10.0.0.0/16 # local subnet
            - 10.42.0.0/24 # Kubernetes Subnet
            - 10.43.0.0/24 # Kubernetes Subnet
    logs:
      general:
        level: DEBUG
      access:
        enabled: true
        fields:
          headers:
            defaultmode: keep
    providers:
      kubernetesCRD:
        allowCrossNamespace: true # Use Middlewares across namespaces
      kubernetesIngress:
        publishedService:
          enabled: true
    ingressRoute:
      dashboard:
        enabled: false
    experimental:
      plugins:
        bouncer:
          moduleName: github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin
          version: v1.2.0
    volumes:
      - name: crowdsec-bouncer-tls
        mountPath: /etc/traefik/crowdsec-certs/
        type: secret
    additionalVolumeMounts:
      - name: plugins
        mountPath: /plugins-storage
    tlsOptions:
      default:
        minVersion: VersionTLS12
        sniStrict: true
        cipherSuites:
          - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
          - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
          - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
          # - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
          # - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
          # - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
          - TLS_AES_128_GCM_SHA256
          - TLS_AES_256_GCM_SHA384
          - TLS_CHACHA20_POLY1305_SHA256
          # - TLS_FALLBACK_SCSV
        curvePreferences:
          - CurveP521
          - CurveP384
    # tlsStore:
    #   default:
    #     defaultCertificate:
    #       secretName: wildcard-powell-place-secret
    resources:
      requests:
        cpu: 10m
        memory: 50Mi
      limits:
        cpu: 300m
        memory: 150Mi
